name: Release Helm Chart

on:
  push:
    branches:
      - main
    paths:
      - 'Chart.yaml'
      - 'values.yaml'
      - 'templates/**'
      - '.github/workflows/release-helm-chart.yml'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  lint-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Lint Helm Chart
        run: |
          helm lint .
          echo "‚úÖ Helm chart linting passed"

      - name: Generate Chart Archive
        run: |
          helm package .
          echo "üì¶ Chart packaged successfully"
          ls -la deepwiki-*.tgz

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Create or update index
        run: |
          mkdir -p /tmp/helm-repo
          cd /tmp/helm-repo
          
          # Copy chart to temp directory
          cp /home/runner/work/deepwiki-open-helmchart/deepwiki-open-helmchart/deepwiki-*.tgz . || true
          
          # Initialize or update index
          if [ -f index.yaml ]; then
            echo "Updating existing index.yaml"
            helm repo index . --url https://neverlless.github.io/deepwiki-open-helmchart/ --merge index.yaml
          else
            echo "Creating new index.yaml"
            helm repo index . --url https://neverlless.github.io/deepwiki-open-helmchart/
          fi
          
          echo "üìã Repository index created"
          cat index.yaml

      - name: Checkout and update gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fetch gh-pages branch
          git fetch origin gh-pages:gh-pages
          git checkout gh-pages
          
          # Copy new files from temp directory
          cp /tmp/helm-repo/deepwiki-*.tgz . 2>/dev/null || true
          cp /tmp/helm-repo/index.yaml . 2>/dev/null || true
          
          # Commit and push
          if git diff --quiet HEAD; then
            echo "‚ÑπÔ∏è  No changes to commit"
          else
            git add -A
            git commit -m "Release Helm chart $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin gh-pages
            echo "‚úÖ Pushed to gh-pages branch"
          fi
